<div class="form-card">
  <h1 class="form-title">Registrar Alojamiento</h1>

  <form [formGroup]="accommodationForm" (ngSubmit)="onSubmit()">

    <!-- Información Básica -->
    <div class="form-section">
      <h2 class="section-title">Información Básica</h2>

      <div class="form-group">
        <label class="label-text">Título del Alojamiento *</label>
        <input type="text" class="form-input" formControlName="titulo"
          placeholder="Ej: Habitación amplia cerca a la UPC"
          [class.error]="hasError('titulo', 'required') || hasError('titulo', 'minlength')">
        <div class="char-counter">
          {{ getControl('titulo')?.value?.length || 0 }} / 10 caracteres
        </div>
        @if (hasError('titulo', 'required')) {
        <div class="error-message">
          El título es obligatorio
        </div>
        }
        @if (hasError('titulo', 'minlength')) {
        <div class="error-message">
          El título debe tener al menos 10 caracteres
        </div>
        }
      </div>

      <div class="form-group">
        <label class="label-text">Descripción Detallada * (mínimo 50 caracteres)</label>
        <textarea class="form-input" rows="4" formControlName="descripcion"
          placeholder="Describe el alojamiento, sus características, comodidades..."
          [class.error]="hasError('descripcion', 'required') || hasError('descripcion', 'minlength')">
        </textarea>
        <div class="char-counter">
          {{ getControl('descripcion')?.value?.length || 0 }} / 50 caracteres
        </div>
        @if (hasError('descripcion', 'required')) {
        <div class="error-message">
          La descripción es obligatoria
        </div>
        }
        @if (hasError('descripcion', 'minlength')) {
        <div class="error-message">
          La descripción debe tener al menos 50 caracteres
        </div>
        }
      </div>

      <div class="form-group">
        <label class="label-text">Dirección Completa *</label>
        <input type="text" class="form-input" formControlName="direccion" placeholder="Calle, número, referencia"
          [class.error]="hasError('direccion', 'required') || hasError('direccion', 'minlength')">
        <div class="char-counter">
          {{ getControl('direccion')?.value?.length || 0 }} / 10 caracteres
        </div>
        @if (hasError('direccion', 'required')) {
        <div class="error-message">
          La dirección es obligatoria
        </div>
        }
        @if (hasError('direccion', 'minlength')) {
        <div class="error-message">
          La dirección debe tener al menos 10 caracteres
        </div>
        }
      </div>

      <div class="form-group">
        <label class="label-text">Número de Partida Registral *</label>
        <input type="text" class="form-input" formControlName="nroPartida" placeholder="Solo números"
          [class.error]="hasError('nroPartida', 'required') || hasError('nroPartida', 'pattern') || hasError('nroPartida', 'minlength')">
        <div class="char-counter">
          {{ getControl('nroPartida')?.value?.length || 0 }} / 8 dígitos
        </div>
        @if (hasError('nroPartida', 'required')) {
        <div class="error-message">
          El número de partida es obligatorio
        </div>
        }
        @if (hasError('nroPartida', 'pattern')) {
        <div class="error-message">
          El número de partida debe contener solo dígitos
        </div>
        }
        @if (hasError('nroPartida', 'minlength')) {
        <div class="error-message">
          El número de partida debe tener al menos 8 dígitos
        </div>
        }
      </div>
    </div>

    <!-- Precio y Ubicación -->
    <div class="form-section">
      <h2 class="section-title">Precio y Ubicación</h2>

      <div class="form-row">
        <div class="form-group">
          <label class="label-text">Precio Mensual * (S/200 - S/5000)</label>
          <input type="number" class="form-input" formControlName="precioMensual" placeholder="S/."
            [class.error]="hasError('precioMensual', 'required') || hasError('precioMensual', 'min') || hasError('precioMensual', 'max')">
          @if (hasError('precioMensual', 'required')) {
          <div class="error-message">
            El precio es obligatorio
          </div>
          }
          @if (hasError('precioMensual', 'min')) {
          <div class="error-message">
            El precio mínimo es S/ 200
          </div>
          }
          @if (hasError('precioMensual', 'max')) {
          <div class="error-message">
            El precio máximo es S/ 5,000
          </div>
          }
        </div>

        <div class="form-group">
          <label class="label-text">Distrito *</label>
          <select class="form-input" formControlName="distritoId" [class.error]="hasError('distritoId', 'required')">
            <option [ngValue]="null">Selecciona un distrito</option>
            @for (district of districts(); track district.id) {
            <option [ngValue]="district.id">
              {{ district.nombre }}
            </option>
            }
          </select>
          @if (hasError('distritoId', 'required')) {
          <div class="error-message">
            Debes seleccionar un distrito
          </div>
          }
        </div>
      </div>
    </div>

    <!-- Características del Inmueble -->
    <div class="form-section">
      <h2 class="section-title">Características del Inmueble</h2>

      <div class="form-row">
        <div class="form-group">
          <label class="label-text">Habitaciones</label>
          <input type="number" class="form-input" formControlName="habitaciones" min="1">
        </div>

        <div class="form-group">
          <label class="label-text">Baños</label>
          <input type="number" class="form-input" formControlName="banios" min="1">
        </div>

        <div class="form-group">
          <label class="label-text">Área (m²)</label>
          <input type="number" class="form-input" formControlName="area" placeholder="Metros cuadrados">
        </div>

        <div class="form-group">
          <label class="label-text">Piso</label>
          <input type="number" class="form-input" formControlName="piso" min="1">
        </div>
      </div>
    </div>

    <!-- Universidades Cercanas -->
    <div class="form-section">
      <h2 class="section-title">Universidades Cercanas *</h2>
      <p class="section-description">Selecciona las universidades cercanas al alojamiento</p>

      <div class="checkbox-grid">
        @for (university of universities(); track university.id) {
        <label class="checkbox-label" [class.selected]="isUniversitySelected(university.id)">
          <input type="checkbox" [checked]="isUniversitySelected(university.id)"
            (change)="toggleUniversity(university.id)">
          <span>{{ university.nombre }}</span>
        </label>
        }
      </div>
      @if (hasError('universidadesIds', 'minArrayLength')) {
      <div class="error-message">
        Debes seleccionar al menos una universidad cercana
      </div>
      }
    </div>

    <!-- Transportes -->
    <div class="form-section">
      <h2 class="section-title">Medios de Transporte Cercanos *</h2>

      <div class="checkbox-grid">
        @for (transport of transportOptions; track transport) {
        <label class="checkbox-label" [class.selected]="isTransportSelected(transport)">
          <input type="checkbox" [checked]="isTransportSelected(transport)" (change)="toggleTransport(transport)">
          <span>{{ transport }}</span>
        </label>
        }
      </div>
      @if (hasError('transportes', 'minArrayLength')) {
      <div class="error-message">
        Debes seleccionar al menos un medio de transporte
      </div>
      }
    </div>

    <!-- Imágenes (RN-014: Máximo 10) -->
    <div class="form-section">
      <h2 class="section-title">Imágenes del Alojamiento * (Máximo 10)</h2>
      <p class="section-description">
        Sube fotos de buena calidad del alojamiento. {{ selectedFiles().length }} / 10 imágenes
      </p>

      <div class="image-upload-container">
        <label class="file-upload-label" [class.disabled]="selectedFiles().length >= 10">
          <input type="file" (change)="onFileSelected($event)" multiple accept="image/*"
            [disabled]="selectedFiles().length >= 10" class="file-input-hidden">
          <div class="upload-box">
            <i class="fas fa-cloud-upload-alt"></i>
            <p>Haz clic para seleccionar imágenes</p>
            <span class="file-hint">JPG, PNG (máx. 5MB por imagen)</span>
          </div>
        </label>

        <!-- Galería de Previsualizaciones -->
        @if (imageUrls().length > 0) {
        <div class="image-preview-grid">
          @for (url of imageUrls(); track url; let i = $index) {
          <div class="image-preview-item">
            <img [src]="url" alt="Preview {{ i + 1 }}">
            <button type="button" class="remove-image-btn" (click)="removeImage(i)" title="Eliminar imagen">
              <i class="fas fa-times"></i>
            </button>
          </div>
          }
        </div>
        }

        @if (selectedFiles().length === 0 && accommodationForm.touched) {
        <div class="error-message">
          Debes subir al menos una imagen del alojamiento
        </div>
        }
      </div>
    </div>

    <!-- Loading Indicator -->
    @if (submitting() || uploadingImages()) {
    <div class="loading-overlay">
      <div class="spinner"></div>
      <p>{{ uploadingImages() ? 'Subiendo imágenes...' : 'Publicando alojamiento...' }}</p>
    </div>
    }

    <!-- Botones de Acción -->
    <div class="form-actions">
      <a routerLink="/landlord/dashboard" class="btn btn-secondary" [class.disabled]="submitting()">
        Cancelar
      </a>
      <button type="submit" class="btn btn-primary btn-publish" [disabled]="submitting() || uploadingImages()">
        @if (!submitting()) {
        <span>Publicar Alojamiento</span>
        }
        @if (submitting()) {
        <span>
          <i class="fas fa-spinner fa-spin"></i> Publicando...
        </span>
        }
      </button>
    </div>
  </form>
</div>